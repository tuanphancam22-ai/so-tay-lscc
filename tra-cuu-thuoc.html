<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra C·ª©u Thu·ªëc - Khoa C·∫•p C·ª©u</title>
    <style>
        :root { --primary: #0C9943; --bg: #f4f7f9; --danger: #d93025; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .header { background: var(--primary); color: white; padding: 15px; border-radius: 12px; text-align: center; margin-bottom: 15px; }
        .search-box { width: 100%; padding: 15px; border-radius: 25px; border: 2px solid #ddd; font-size: 16px; box-sizing: border-box; margin-bottom: 15px; outline: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* Drug Card */
        .drug-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; border-left: 5px solid var(--primary); transition: 0.2s; }
        .drug-card:active { transform: scale(0.98); }
        .drug-title { color: var(--primary); font-size: 18px; font-weight: bold; margin-bottom: 5px; text-transform: capitalize; }
        .drug-sub { font-size: 14px; color: #555; line-height: 1.4; }
        .hashtag { color: #007bff; font-size: 12px; font-style: italic; display: block; margin-top: 5px; }

        /* Modal Details */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center; }
        .modal { width: 95%; height: 92%; background: white; border-radius: 15px; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; background: #f8f8f8; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; border-bottom: 1px solid #eee; z-index: 11; }
        .modal-body { padding: 15px; flex-grow: 1; }
        .close-btn { background: var(--danger) !important; color: white !important; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .field-label { font-weight: bold; color: var(--primary); margin-top: 12px; display: block; font-size: 14px; }
        .field-content { font-size: 15px; margin-top: 4px; padding: 8px; background: #f9f9f9; border-radius: 6px; color: #333; min-height: 20px; }

        /* Calculator Update */
        .calc-box { background: #eef9f1; padding: 15px; border-radius: 12px; margin-top: 25px; border: 2px dashed var(--primary); }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        label { font-size: 11px; font-weight: bold; color: #666; text-transform: uppercase; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; margin-top: 4px; box-sizing: border-box; font-size: 15px; }
        .res-calc { background: var(--primary); color: white; padding: 15px; border-radius: 10px; margin-top: 15px; text-align: center; }

        /* L·ªõp ph·ªß b·∫£o v·ªá: Cho ph√©p nh√¨n, cho ph√©p t√¨m nh∆∞ng C·∫§M B·∫§M */
        .lock-interaction {
        pointer-events: none; /* V√¥ hi·ªáu h√≥a m·ªçi c√∫ click chu·ªôt/ch·∫°m tay */
        opacity: 0.85;        /* L√†m m·ªù nh·∫π ƒë·ªÉ t·∫°o c·∫£m gi√°c "ƒëang x·ª≠ l√Ω" */
        user-select: none;    /* Kh√¥ng cho b√¥i ƒëen copy */
        }
    </style>
</head>
<body>

    <div class="header">
        <h2 style="margin:0; font-size: 18px;">üíä TRA C·ª®U & T√çNH LI·ªÄU THU·ªêC</h2>
    </div>

    <input type="text" id="searchInput" class="search-box" placeholder="T√¨m ho·∫°t ch·∫•t, BHYT, Vi·ªán ph√≠, Nh√≥m..." onkeyup="searchDrug()">
    
    <div id="loading" style="text-align:center; padding: 20px; color: #666;">ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu...</div>
    <div class="status-msg">
    ‚ö†Ô∏è <b>Th√¥ng b√°o:</b> D·ªØ li·ªáu chuy√™n m√¥n ƒëang ƒë∆∞·ª£c th·∫©m ƒë·ªãnh. Hi·ªán ch·ªâ kh·∫£ d·ª•ng ch·ª©c nƒÉng tra c·ª©u t√™n thu·ªëc.
    </div>
    
    <div id="drugList" class="lock-interaction"></div>

    <div id="detailOverlay" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <span id="m-title" style="font-weight:bold; color:var(--primary); font-size: 16px;"></span>
                <button class="close-btn" onclick="closeDetail()">ƒê√ìNG</button>
            </div>
            <div class="modal-body">
                <span class="field-label">üè• H·ªá BHYT:</span> <div id="m-bhyt" class="field-content"></div>
                <span class="field-label">üí∏ H·ªá Vi·ªán ph√≠:</span> <div id="m-vp" class="field-content"></div>
                <span class="field-label">‚úÖ Ch·ªâ ƒë·ªãnh:</span> <div id="m-cd" class="field-content"></div>
                <span class="field-label">‚ùå Ch·ªëng ch·ªâ ƒë·ªãnh:</span> <div id="m-ccd" class="field-content"></div>
                <span class="field-label">‚öñÔ∏è Li·ªÅu d√πng tham kh·∫£o:</span> <div id="m-lieu" class="field-content"></div>
                <span class="field-label">üè∑Ô∏è Nh√≥m thu·ªëc:</span> <div id="m-nhom" class="field-content"></div>

                <div class="calc-box">
                    <h3 style="margin:0 0 12px 0; color:var(--primary); font-size: 15px; text-align: center;">üßÆ M√ÅY T√çNH T·ªêC ƒê·ªò TRUY·ªÄN</h3>
                    <div class="input-row">
                        <div><label>C√¢n n·∫∑ng (kg)</label><input type="number" id="w" value="50"></div>
                        <div><label>Li·ªÅu ƒë√≠ch</label><input type="number" id="dose" step="0.01" placeholder="0.1"></div>
                    </div>
                    <div class="input-row">
                        <div>
                            <label>ƒê∆°n v·ªã li·ªÅu</label>
                            <select id="unit">
                                <option value="ugkgmin">¬µg/kg/ph√∫t</option>
                                <option value="ugmin">¬µg/ph√∫t</option>
                                <option value="mgh">mg/gi·ªù</option>
                            </select>
                        </div>
                        <div><label>H√†m l∆∞·ª£ng/1 ·ªëng (mg)</label><input type="number" id="mg_per_amp" value="1"></div>
                    </div>
                    <div class="input-row">
                        <div><label>S·ªë ·ªëng pha</label><input type="number" id="amp_count" value="5"></div>
                        <div><label>T·ªïng d·ªãch pha (ml)</label><input type="number" id="vol" value="500"></div>
                    </div>
                    <div class="input-row">
                        <div style="grid-column: span 2;"><label>B·ªô d√¢y (gi·ªçt/ml) - M·∫∑c ƒë·ªãnh 20</label><input type="number" id="df" value="20"></div>
                    </div>
                    <button onclick="calculateInfusion()" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:bold; font-size: 16px;">T√çNH T·ªêC ƒê·ªò</button>
                    
                    <div id="calcResult" class="res-calc" style="display:none;">
                        <div id="res-mlh" style="font-size: 22px; font-weight: bold;"></div>
                        <div id="res-gtt" style="font-size: 16px; margin-top: 5px; opacity: 0.9;"></div>
                    </div>
                </div>
                <p style="font-size: 10px; color: #999; margin-top: 15px; text-align: center;">L∆∞u √Ω: Lu√¥n ki·ªÉm tra l·∫°i n·ªìng ƒë·ªô th·ª±c t·∫ø tr∆∞·ªõc khi truy·ªÅn.</p>
            </div>
        </div>
    </div>

    <script>
        // THAY ID SHEET C·ª¶A B·∫†N V√ÄO ƒê√ÇY
        const SHEET_ID = '1REXuH0gV0GvQG96elQ0NWODek31vLaQCNO8gnBtSdKE';
        const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Thuoc`;

        let drugs = [];
        let currentDisplayList = []; // Bi·∫øn n√†y ƒë·ªÉ l∆∞u danh s√°ch ƒëang hi·ªÉn th·ªã (ƒë√£ t√¨m ki·∫øm)

        async function loadData() {
            try {
                const res = await fetch(URL);
                const text = await res.text();
                
                // S·ª≠ d·ª•ng Regex n√¢ng cao ƒë·ªÉ x·ª≠ l√Ω d·∫•u ph·∫©y trong n·ªôi dung √¥
                const rows = text.split(/\r?\n/).slice(1);
                drugs = rows.map(r => {
                    const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    return {
                        hc: (c[0] || "").replace(/"/g,'').trim(),
                        bhyt: (c[1] || "").replace(/"/g,'').trim(),
                        vp: (c[2] || "").replace(/"/g,'').trim(),
                        cd: (c[3] || "").replace(/"/g,'').trim(),
                        ccd: (c[4] || "").replace(/"/g,'').trim(),
                        lieu: (c[5] || "").replace(/"/g,'').trim(),
                        nhom: (c[6] || "").replace(/"/g,'').trim()
                    };
                })
                .filter(d => d.hc || d.bhyt || d.vp) // Gi·ªØ l·∫°i n·∫øu √≠t nh·∫•t c√≥ 1 lo·∫°i t√™n
                // 2. S·∫Øp x·∫øp A-Z theo Ho·∫°t ch·∫•t
                .sort((a, b) => (a.hc || a.bhyt).localeCompare(b.hc || b.bhyt));

                renderDrugs(drugs);
                document.getElementById('loading').style.display='none';
            } catch (e) { 
                document.getElementById('loading').innerText = "L·ªói t·∫£i d·ªØ li·ªáu. H√£y ki·ªÉm tra Sheet!";
            }
        }

        function renderDrugs(list) {
            currentDisplayList = list; // C·∫≠p nh·∫≠t danh s√°ch th·ª±c t·∫ø ƒëang hi·ªán tr√™n m√†n h√¨nh
            const container = document.getElementById('drugList');
            container.innerHTML = list.map((d, index) => `
                <div class="drug-card" onclick="openDetail(${index})">
                    <div class="drug-title">${d.hc || "---"}</div>
                    <div class="drug-sub">
                        <b>BHYT:</b> ${d.bhyt || "---"}<br>
                        <b>Vi·ªán ph√≠:</b> ${d.vp || "---"}
                        <span class="hashtag">${d.nhom || ""}</span>
                    </div>
                </div>
            `).join('');
        }


        function searchDrug() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const filtered = drugs.filter(d => 
                d.hc.toLowerCase().includes(q) || 
                d.bhyt.toLowerCase().includes(q) || 
                d.vp.toLowerCase().includes(q) || 
                d.nhom.toLowerCase().includes(q)
            );
            // G·ªçi h√†m render v·ªõi danh s√°ch ƒë√£ l·ªçc
            renderDrugs(filtered); 
        }
        
        function openDetail(index) {
            // Quan tr·ªçng: L·∫•y d·ªØ li·ªáu t·ª´ currentDisplayList thay v√¨ drugs
            const d = currentDisplayList[index]; 
            
            document.getElementById('m-title').innerText = d.hc || "Th√¥ng tin thu·ªëc";
            document.getElementById('m-bhyt').innerText = d.bhyt || "---";
            document.getElementById('m-vp').innerText = d.vp || "---";
            document.getElementById('m-cd').innerText = d.cd || "---";
            document.getElementById('m-ccd').innerText = d.ccd || "---";
            document.getElementById('m-lieu').innerText = d.lieu || "---";
            document.getElementById('m-nhom').innerText = d.nhom || "---";
            document.getElementById('detailOverlay').style.display = 'flex';
        }

        function closeDetail() {
            document.getElementById('detailOverlay').style.display = 'none';
            document.getElementById('calcResult').style.display = 'none';
        }

        // 3. C√¥ng th·ª©c t√≠nh t·ªëc ƒë·ªô truy·ªÅn m·ªõi
        function calculateInfusion() {
            const weight = parseFloat(document.getElementById('w').value) || 0;
            const doseTarget = parseFloat(document.getElementById('dose').value) || 0;
            const unit = document.getElementById('unit').value;
            const mgPerAmp = parseFloat(document.getElementById('mg_per_amp').value) || 0;
            const ampCount = parseFloat(document.getElementById('amp_count').value) || 0;
            const volume = parseFloat(document.getElementById('vol').value) || 0;
            const dropFactor = parseFloat(document.getElementById('df').value) || 20;

            if (volume === 0 || (mgPerAmp * ampCount) === 0) {
                alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin n·ªìng ƒë·ªô!");
                return;
            }

            // T·ªïng mg thu·ªëc
            const totalMg = mgPerAmp * ampCount;
            // N·ªìng ƒë·ªô ¬µg/ml
            const conc_ug_ml = (totalMg * 1000) / volume;

            let mlh = 0;
            if (unit === "ugkgmin") {
                mlh = (doseTarget * weight * 60) / conc_ug_ml;
            } else if (unit === "ugmin") {
                mlh = (doseTarget * 60) / conc_ug_ml;
            } else if (unit === "mgh") {
                // ƒê·ªïi mg/h tr·ª±c ti·∫øp sang ml/h
                mlh = doseTarget / (totalMg / volume);
            }

            const gtt = (mlh * dropFactor) / 60;

            document.getElementById('calcResult').style.display = 'block';
            document.getElementById('res-mlh').innerText = mlh.toFixed(1) + " ml/gi·ªù";
            document.getElementById('res-gtt').innerText = "‚âà " + Math.round(gtt) + " gi·ªçt/ph√∫t";
        }

        window.onload = loadData;
    </script>
</body>
</html>
