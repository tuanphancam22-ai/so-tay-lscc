<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thư viện Phác đồ</title>
    <style>
        :root { --primary-color: #0C9943; }
        body { font-family: -apple-system, sans-serif; background: #f4f7f9; margin: 0; padding: 15px; overflow-x: hidden; }
        .back-btn { display: inline-block; margin-bottom: 15px; text-decoration: none; color: var(--primary-color); font-weight: bold; }
        .header { background: var(--primary-color); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        
        /* Thanh tìm kiếm */
        .search-box { width: 100%; padding: 15px; border-radius: 25px; border: 2px solid #ddd; font-size: 16px; box-sizing: border-box; margin-bottom: 20px; outline: none; }

        /* Danh sách */
        .protocol-item { 
            background: white; padding: 18px; border-radius: 12px; margin-bottom: 10px;
            color: #333; font-weight: 600; display: flex; justify-content: space-between; 
            align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #ccc; cursor: pointer;
        }
        .protocol-item:hover { border-left-color: var(--primary-color); }

        /* Overlay (Lớp nền mờ) */
        .overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; 
        }

        /* Modal chứa tài liệu */
        .modal { 
            width: 95%; height: 90%; background: white; border-radius: 15px; overflow: hidden; 
            position: relative; display: flex; flex-direction: column; 
        }

        /* Sửa lại nút Đóng cho rực rỡ và dễ thấy */
        .close-btn { 
            background: #d93025 !important; /* Đảm bảo luôn là màu đỏ */
            color: white !important; 
            border: none; 
            padding: 8px 18px; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Đây là phần mới thêm vào để tạo khung chứa iframe bảo mật */
        .iframe-container {
            position: relative;
            flex-grow: 1;
            width: 100%;
            overflow: hidden;
        }

        /* Dải tàng hình chặn không cho bấm vào nút Download/Mở cửa sổ mới của Google */
        .blocker-top {
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 55px; /* Độ cao này sẽ che vừa đủ thanh công cụ của Drive */
            background: transparent;
            z-index: 10;
        }

        iframe { width: 100%; height: 100%; border: none; }

        .loading { text-align: center; color: #666; margin-top: 50px; }
    </style>
</head>
<body>

    <a href="index.html" class="back-btn">← Trang chủ</a>
    <div class="header"><h2>THƯ VIỆN PHÁC ĐỒ</h2></div>

    <input type="text" id="searchInput" class="search-box" placeholder="Tìm tên phác đồ..." onkeyup="filterProtocols()">

    <div id="loading" class="loading">Đang tải danh sách...</div>
    <div id="protocolContainer"></div>

    <div id="docOverlay" class="overlay">
        <div class="modal">
            <div class="modal-header">
                <span id="modalTitle" style="font-weight: bold; font-size: 14px; color: #333;"></span>
                <button class="close-btn" onclick="closeDoc()">ĐÓNG</button>
            </div>
            <div class="iframe-container">
                <div class="blocker-top"></div> 
                <iframe id="docFrame" src=""></iframe>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1REXuH0gV0GvQG96elQ0NWODek31vLaQCNO8gnBtSdKE';
        const SHEET_NAME = 'PhacDo'; 
        const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;

        let allProtocols = [];

        async function loadProtocols() {
            try {
                const res = await fetch(URL);
                const text = await res.text();
                const rows = text.split('\n').slice(1);
                
                allProtocols = rows.map(r => {
                    const cols = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    return {
                        name: cols[0]?.replace(/"/g,'').trim(),
                        link: cols[1]?.replace(/"/g,'').trim()
                    };
                }).filter(p => p.name && p.link);

                displayProtocols(allProtocols);
                document.getElementById('loading').style.display = 'none';
            } catch (error) { console.error(error); }
        }

        function displayProtocols(list) {
            const container = document.getElementById('protocolContainer');
            container.innerHTML = list.map(p => `
                <div class="protocol-item" onclick="openDoc('${p.link}', '${p.name}')">
                    <span>${p.name}</span>
                    <span style="color:#bbb;">➔</span>
                </div>
            `).join('');
        }

        // Hàm xử lý link Google Drive để nhúng
        function openDoc(link, name) {
            let embedLink = link;
            
            // Chuyển đổi link Drive thông thường sang link nhúng (preview)
            if (link.includes('drive.google.com')) {
                if (link.includes('/view')) {
                    embedLink = link.replace('/view', '/preview');
                } else if (link.includes('id=')) {
                    // Xử lý link dạng ?id=xxx
                    const id = link.split('id=')[1].split('&')[0];
                    embedLink = `https://drive.google.com/file/d/${id}/preview`;
                }
            }

            document.getElementById('modalTitle').innerText = name;
            document.getElementById('docFrame').src = embedLink;
            document.getElementById('docOverlay').style.display = 'flex';
            document.body.style.overflow = 'hidden'; // Chặn cuộn trang chính
        }

        function closeDoc() {
            document.getElementById('docOverlay').style.display = 'none';
            document.getElementById('docFrame').src = '';
            document.body.style.overflow = 'auto';
        }

        function filterProtocols() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allProtocols.filter(p => p.name.toLowerCase().includes(query));
            displayProtocols(filtered);
        }

        window.onload = loadProtocols;
    </script>
</body>
</html>
