<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·ªï Tay L√¢m S√†ng - Minh Ch√≠</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f7f9; padding: 15px; margin: 0; }
        .header-app { background: #007bff; color: white; padding: 20px 15px; margin: -15px -15px 15px -15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; text-align: center; }
        .nav-buttons { display: flex; gap: 5px; margin-top: 15px; }
        .nav-btn { flex: 1; padding: 12px 5px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-size: 14px; transition: 0.3s; }
        .search-bar, .abg-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 5px solid #007bff; }
        .category { font-size: 11px; color: #007bff; font-weight: bold; text-transform: uppercase; }
        .title { font-size: 18px; margin: 5px 0; color: #333; font-weight: bold; }
        .detail { font-size: 14px; color: #555; line-height: 1.4; white-space: pre-wrap; }
        .red-flag { background: #fff1f0; color: #d93025; padding: 8px; border-radius: 6px; font-size: 13px; font-weight: bold; margin-top: 10px; border: 1px solid #ffccc7; }
        .gcs-select { width: 100%; padding: 14px; border-radius: 8px; margin-bottom: 15px; background: white; border: 1.5px solid #007bff; font-size: 16px; }
        .input-group { text-align: left; margin-bottom: 10px; }
        .input-group label { font-weight: bold; font-size: 14px; color: #444; display: block; margin-bottom: 5px; }
        #abg-result-box { margin-top:15px; padding:15px; background:white; border-radius:12px; border:2px solid #007bff; text-align: left; }
    </style>
</head>
<body>

    <div class="header-app">
        <h2 style="margin:0;">üöë S·ªï Tay L√¢m S√†ng</h2>
        <div class="nav-buttons">
            <button class="nav-btn" onclick="switchMode('lookup')" id="btn-lookup" style="background:white; color:#007bff;">TRA C·ª®U</button>
            <button class="nav-btn" onclick="switchMode('gcs')" id="btn-gcs" style="background:#0056b3; color:white;">GCS</button>
            <button class="nav-btn" onclick="switchMode('abg')" id="btn-abg" style="background:#0056b3; color:white;">KH√ç M√ÅU</button>
        </div>
    </div>

    <div id="lookup-section">
        <input type="text" id="searchInput" class="search-bar" placeholder="T√¨m ph√°c ƒë·ªì, thu·ªëc...">
        <div id="content">ƒêang t·∫£i d·ªØ li·ªáu...</div>
    </div>

    <div id="gcs-section" style="display:none; text-align: center;">
        <h3>Thang ƒëi·ªÉm Glasgow</h3>
        <div class="input-group"><label>M·∫Øt (E):</label><select id="e_score" class="gcs-select" onchange="calcGCS()"></select></div>
        <div class="input-group"><label>L·ªùi n√≥i (V):</label><select id="v_score" class="gcs-select" onchange="calcGCS()"></select></div>
        <div class="input-group"><label>V·∫≠n ƒë·ªông (M):</label><select id="m_score" class="gcs-select" onchange="calcGCS()"></select></div>
        <div id="gcs-result" style="padding:20px; background:#28a745; color:white; border-radius:12px; margin-top: 10px;">
            <h1 id="total-score" style="margin:0;">15 ƒëi·ªÉm</h1>
            <p id="gcs-status" style="margin:5px 0 0 0; font-weight: bold;">B√¨nh th∆∞·ªùng</p>
        </div>
    </div>

    <div id="abg-section" style="display:none; text-align: center;">
        <h3>Ph√¢n t√≠ch Kh√≠ m√°u chuy√™n s√¢u</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="input-group"><label>pH:</label><input type="number" id="abg_ph" class="abg-input" step="0.01" placeholder="7.40"></div>
            <div class="input-group"><label>pCO2:</label><input type="number" id="abg_pco2" class="abg-input" placeholder="40"></div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <div class="input-group"><label>HCO3-:</label><input type="number" id="abg_hco3" class="abg-input" placeholder="24"></div>
            <div class="input-group"><label>Na+ (Natri):</label><input type="number" id="abg_na" class="abg-input" placeholder="140"></div>
        </div>
        <div class="input-group"><label>Cl- (Clo):</label><input type="number" id="abg_cl" class="abg-input" placeholder="100"></div>
        <button onclick="analyzeABG()" style="width:100%; padding:15px; background:#007bff; color:white; border:none; border-radius:10px; font-weight:bold; font-size:16px; cursor:pointer;">PH√ÇN T√çCH ABG</button>

        <div id="abg-result-box" style="display:none;">
            <h4 id="abg-diag" style="margin:0; color:#d93025; font-size: 18px;"></h4>
            <div id="abg-details" style="font-size: 14px; margin-top: 10px; color: #444; line-height: 1.6;"></div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1REXuH0gV0GvQG96elQ0NWODek31vLaQCNO8gnBtSdKE';
        const URL_LOOKUP = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1`;
        const URL_GCS = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=GCS`;

        // CHUY·ªÇN CH·∫æ ƒê·ªò (FIX L·ªñI M·∫§T GCS)
        function switchMode(mode) {
            document.getElementById('lookup-section').style.display = (mode === 'lookup' ? 'block' : 'none');
            document.getElementById('gcs-section').style.display = (mode === 'gcs' ? 'block' : 'none');
            document.getElementById('abg-section').style.display = (mode === 'abg' ? 'block' : 'none');
            
            const btns = ['btn-lookup', 'btn-gcs', 'btn-abg'];
            btns.forEach(b => {
                const el = document.getElementById(b);
                if(b === 'btn-' + mode) {
                    el.style.background = "white"; el.style.color = "#007bff";
                } else {
                    el.style.background = "#0056b3"; el.style.color = "white";
                }
            });
        }

        // PH√ÇN T√çCH KH√ç M√ÅU CHUY√äN S√ÇU
        function analyzeABG() {
            const ph = parseFloat(document.getElementById('abg_ph').value);
            const pco2 = parseFloat(document.getElementById('abg_pco2').value);
            const hco3 = parseFloat(document.getElementById('abg_hco3').value);
            const na = parseFloat(document.getElementById('abg_na').value);
            const cl = parseFloat(document.getElementById('abg_cl').value);

            if (!ph || !pco2 || !hco3) return alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t pH, pCO2 v√† HCO3!");

            let diag = "";
            let details = "";

            // Logic pH
            if (ph < 7.35) diag = "TOAN "; else if (ph > 7.45) diag = "KI·ªÄM "; else diag = "pH B√åNH TH∆Ø·ªúNG ";

            // Logic H√¥ h·∫•p/Chuy·ªÉn h√≥a
            if (pco2 > 45 && ph < 7.4) diag += "H√î H·∫§P";
            else if (hco3 < 22 && ph < 7.4) diag += "CHUY·ªÇN H√ìA";
            else if (pco2 < 35 && ph > 7.4) diag += "H√î H·∫§P";
            else if (hco3 > 26 && ph > 7.4) diag += "CHUY·ªÇN H√ìA";

            // Winters Formula cho Toan chuy·ªÉn h√≥a
            if (diag.includes("TOAN CHUY·ªÇN H√ìA")) {
                const expectedPCO2 = (1.5 * hco3) + 8;
                details += `‚Ä¢ <b>Winters:</b> pCO2 k·ª≥ v·ªçng ‚âà ${expectedPCO2.toFixed(1)} ¬± 2.<br>`;
                if (pco2 > expectedPCO2 + 2) details += `‚Üí K√®m Toan h√¥ h·∫•p h·ªón h·ª£p.<br>`;
                else if (pco2 < expectedPCO2 - 2) details += `‚Üí K√®m Ki·ªÅm h√¥ h·∫•p h·ªón h·ª£p.<br>`;
                else details += `‚Üí B√π tr·ª´ h√¥ h·∫•p ph√π h·ª£p.<br>`;
            }

            // Anion Gap (AG)
            if (na && cl) {
                const ag = na - (cl + hco3);
                details += `‚Ä¢ <b>Anion Gap:</b> ${ag.toFixed(1)} (B√¨nh th∆∞·ªùng: 12 ¬± 4).<br>`;
                if (ag > 16) details += `‚Üí Toan chuy·ªÉn h√≥a tƒÉng AG.<br>`;
            }

            document.getElementById('abg-result-box').style.display = "block";
            document.getElementById('abg-diag').innerText = diag;
            document.getElementById('abg-details').innerHTML = details || "·ªîn ƒë·ªãnh, ch∆∞a ph√°t hi·ªán r·ªëi lo·∫°n b√π tr·ª´.";
        }

        // T·∫¢I D·ªÆ LI·ªÜU
        let dataLookup = [];
        async function fetchData() {
            try {
                // T·∫£i Sheet1
                const res1 = await fetch(URL_LOOKUP);
                const text1 = await res1.text();
                const rows1 = text1.split('\n').slice(1);
                dataLookup = rows1.map(row => {
                    const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                    const clean = cols.map(c => c.replace(/^"|"$/g, '').trim());
                    return { cat: clean[0], title: clean[1], detail: clean[2], alert: clean[3] };
                });
                renderLookup(dataLookup);

                // T·∫£i GCS
                const res2 = await fetch(URL_GCS);
                const text2 = await res2.text();
                const rows2 = text2.split('\n').slice(1);
                const gcsItems = rows2.map(row => {
                    const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                    const clean = cols.map(c => c.replace(/^"|"$/g, '').trim());
                    return { nhom: clean[0], mo: clean[1], diem: clean[2] };
                });

                const fill = (id, group) => {
                    const sel = document.getElementById(id);
                    const items = gcsItems.filter(i => i.nhom === group);
                    sel.innerHTML = items.map(i => `<option value="${i.diem}">${i.diem} - ${i.mo}</option>`).join('');
                };
                fill('e_score', 'M·∫Øt'); fill('v_score', 'L·ªùi n√≥i'); fill('m_score', 'V·∫≠n ƒë·ªông');
                calcGCS();
            } catch (e) { console.error("L·ªói t·∫£i d·ªØ li·ªáu", e); }
        }

        function renderLookup(list) {
            document.getElementById('content').innerHTML = list.map(item => `
                <div class="card">
                    <div class="category">${item.cat || ''}</div>
                    <div class="title">${item.title || ''}</div>
                    <div class="detail">${item.detail || ''}</div>
                    ${item.alert ? `<div class="red-flag">‚ö†Ô∏è ${item.alert}</div>` : ''}
                </div>
            `).join('');
        }

        function calcGCS() {
            const e = parseInt(document.getElementById('e_score').value) || 0;
            const v = parseInt(document.getElementById('v_score').value) || 0;
            const m = parseInt(document.getElementById('m_score').value) || 0;
            const total = e + v + m;
            document.getElementById('total-score').innerText = total + " ƒëi·ªÉm";
            let s = "B√¨nh th∆∞·ªùng", c = "#28a745";
            if (total <= 8) { s = "‚ö†Ô∏è N·∫∂NG - ƒê·∫∑t NKQ!"; c = "#dc3545"; }
            else if (total <= 12) { s = "TRUNG B√åNH"; c = "#ffc107"; }
            document.getElementById('gcs-result').style.background = c;
            document.getElementById('gcs-status').innerText = s;
        }

        document.getElementById('searchInput').oninput = (e) => {
            const term = e.target.value.toLowerCase();
            renderLookup(dataLookup.filter(i => (i.title || "").toLowerCase().includes(term)));
        };

        window.onload = fetchData;
    </script>
</body>
</html>
