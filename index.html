<script>
    const SHEET_ID = '1REXuH0gV0GvQG96elQ0NWODek31vLaQCNO8gnBtSdKE';
    const SHEET_NAME = 'Sheet1';
    const URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;

    let data = [];

    async function fetchData() {
        try {
            const response = await fetch(URL);
            const text = await response.text();
            
            // Xử lý CSV an toàn hơn bằng Regex
            const rows = text.split('\n').slice(1);
            data = rows.map(row => {
                // Tách các cột theo dấu phẩy nhưng bỏ qua dấu phẩy nằm trong ngoặc kép
                const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                const cleanCols = cols.map(c => c.replace(/^"|"$/g, '').trim());
                
                return { 
                    cat: cleanCols[0] || "Chưa phân loại", 
                    title: cleanCols[1] || "Không tiêu đề", 
                    detail: cleanCols[2] || "", 
                    alert: cleanCols[3] || "" 
                };
            });
            
            render(data);
        } catch (error) {
            console.error("Lỗi lấy dữ liệu:", error);
            document.getElementById('content').innerHTML = "<p style='color:red; padding:20px;'>Lỗi kết nối dữ liệu! Hãy kiểm tra quyền chia sẻ của Google Sheet.</p>";
        }
    }

    function render(list) {
        const container = document.getElementById('content');
        if (!container) return;

        if (list.length === 0) {
            container.innerHTML = "<p style='padding:20px;'>Không tìm thấy nội dung...</p>";
            return;
        }

        container.innerHTML = list.map(item => `
            <div class="card" style="background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-left: 5px solid #007bff;">
                <div class="category" style="font-size: 11px; color: #007bff; font-weight: bold; text-transform: uppercase;">${item.cat}</div>
                <div class="title" style="font-size: 18px; margin: 5px 0; color: #333; font-weight: bold;">${item.title}</div>
                <div class="detail" style="font-size: 14px; color: #555;">${item.detail}</div>
                ${item.alert ? `<div class="red-flag" style="background: #fff1f0; color: #d93025; padding: 8px; border-radius: 6px; font-size: 13px; font-weight: bold; margin-top: 10px; border: 1px solid #ffccc7;">⚠️ ${item.alert}</div>` : ''}
            </div>
        `).join('');
    }

    // Đảm bảo các phần tử HTML đã tồn tại trước khi gán sự kiện
    window.onload = () => {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = data.filter(i => 
                    i.title.toLowerCase().includes(term) ||
                    i.cat.toLowerCase().includes(term)
                );
                render(filtered);
            });
        }
        fetchData();
    };
</script>
